# This file is part of Adblock Plus <https://adblockplus.org/>,
# Copyright (C) 2006-present eyeo GmbH
#
# Adblock Plus is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 3 as
# published by the Free Software Foundation.
#
# Adblock Plus is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Adblock Plus.  If not, see <http://www.gnu.org/licenses/>.
#
# This file specifies how GitLab should run the tests, linting and other checks
# automatically when merge requests are opened. By default, this will all run
# on GitLab provided "shared runners", without further work. However, the tests
# will run more quickly on a "specific runner" if you'd like to set that up.
#
# If you'd like to provision your own specific runners for your fork of the
# repository, you can use these Ansible roles:
#
# https://gitlab.com/eyeo/devops/ansible-role-adblockplus-builder
# https://gitlab.com/eyeo/devops/ansible-role-gitlab-runner


---

stages:
  - default
  - testpages
  - pages

image: "registry.gitlab.com/eyeo/docker/adblockplus-ci:node16-no-python"

variables:
  npm_config_audit: "false"

.default_template:
  stage: default
  before_script:
    - npm install
  retry:
    max: 2
    when: stuck_or_timeout_failure

tests:
  extends: .default_template
  script:
    - npm test
    - npm run test:dist
  cache:
    key: global-cache
    paths:
      - browser-snapshots/*/cache/

benchmark:
  extends: .default_template
  script:
    - npm run benchmark
    - npm run benchmark:save
    - npm run benchmark:compare

.docker-image:
  image: docker:19.03.5
  services:
    - docker:19.03.5-dind
  variables:
    DOCKER_DRIVER: overlay2

build:testpages-extension:
  stage: default
  extends: .docker-image
  script:
    - docker build -t extensionforcore -f test/dockerfiles/extension.Dockerfile .
    - docker run extensionforcore
    - docker cp $(docker ps -aqf ancestor=extensionforcore):/extension .
  artifacts:
    paths:
      - extension
    expire_in: 1 month

.testpages:
  stage: testpages
  extends: .docker-image
  interruptible: true
  # Disabled because of https://gitlab.com/eyeo/adblockplus/abc/adblockpluscore/-/issues/430
  # Until we fix webext-sdk
  allow_failure: true
  variables:
    MANIFEST: mv2
  needs:
    - job: build:testpages-extension
      artifacts: true
  before_script:
    - apk add git
    - git clone https://gitlab.com/eyeo/adblockplus/abc/testpages.adblockplus.org.git
    - cp "extension/extension"$MANIFEST".zip" testpages.adblockplus.org
  script:
    - cd testpages.adblockplus.org &&
      docker build -t testpages --build-arg EXTENSION_FILE="extension"$MANIFEST".zip" . &&
      docker run --shm-size=512m -e SKIP_EXTENSION_DOWNLOAD="true" -e TESTS_EXCLUDE="Snippets$SKIP" -e BROWSER="$BROWSER" testpages
  after_script:
    - docker cp $(docker ps -aqf ancestor=testpages):/testpages.adblockplus.org/test/screenshots .
      2> /dev/null
  artifacts:
    paths:
      - screenshots/
    when: always
    expire_in: 1 mo

testpages:v2:chrome:latest:
  extends: .testpages
  variables:
    BROWSER: chromium latest

testpages:v2:chrome:oldest:
  extends: .testpages
  variables:
    BROWSER: chromium 77.0.3865.0

testpages:v2:chrome:beta:
  extends: .testpages
  allow_failure: true
  variables:
    BROWSER: chromium beta

testpages:v2:firefox:latest:
  extends: .testpages
  variables:
    BROWSER: firefox latest

testpages:v2:firefox:oldest:
  extends: .testpages
  variables:
    BROWSER: firefox 68.0

testpages:v2:firefox:beta:
  extends: .testpages
  allow_failure: true
  variables:
    BROWSER: firefox beta

.testpages:v3:
  extends: .testpages
  variables:
    MANIFEST: mv3
    SKIP: "|Header|Sitekey|Subscriptions"

testpages:v3:chrome:latest:
  extends: .testpages:v3
  variables:
    BROWSER: chromium latest

testpages:v3:chrome:beta:
  extends: .testpages:v3
  variables:
    BROWSER: chromium beta

docs:
  extends: .default_template
  script:
    - npm run docs
  artifacts:
    paths:
      - build/docs/
    expire_in: 3 mos

audit:
  extends: .default_template
  script:
    - npm audit --production
  allow_failure: true

.pages:
  stage: pages
  dependencies:
    - docs

include: ".gitlab-pages.yml"